<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Key Ng√†y H√¥m Nay L√†</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f9f5f3;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .loading-container {
            text-align: center;
            padding: 20px;
            border: 2px solid #ef8682;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
            background-color: #fff;
            width: 80vw;
            max-width: 420px;
        }
        h1 { color: #03fcec; font-size: 28px; margin-bottom: 12px; }
        .key-label { font-size: 14px; color: #888; margin-bottom: 5px; }
        .key-container { display:flex; flex-direction:column; align-items:center; }
        input {
            text-align:center; width:80%; padding:12px; margin-bottom:12px;
            border:2px solid #fc0303; border-radius:8px; font-size:16px;
            background:#f8f8f8; font-weight:bold;
        }
        .button-group { display:flex; gap:10px; justify-content:center; flex-wrap:wrap; }
        button {
            background-color:#ef8682; color:#fff; padding:12px 18px; border:none;
            border-radius:8px; cursor:pointer; font-size:15px; min-width:140px;
        }
        button:hover { background-color:#e9514d; }
        .footer { text-align:center; margin-top:16px; color:#555; font-size:14px; }
        #player { display:none; } /* youtube player hidden */

        /* Overlay when access is not allowed */
        .blocked-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.6);
            z-index: 9999;
            padding: 20px;
            box-sizing: border-box;
        }
        .blocked-panel {
            background: #fff;
            padding: 18px;
            border-radius: 10px;
            max-width: 520px;
            width: 100%;
            text-align: center;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
        }
        .blocked-panel h2 { margin: 0 0 8px 0; color:#f60000; }
        .blocked-panel p { color:#444; margin:0 0 14px 0; }
        .blocked-panel a { color:#ef8682; text-decoration:none; font-weight:bold; }
    </style>
</head>
<body>
    <!-- Hidden container for YouTube player (kept hidden) -->
    <div id="player"></div>

    <div class="loading-container" id="mainContainer">
        <h1>üîë KEY C·ª¶A B·∫†N L√Ä</h1>
        <div class="key-label">(Key t·ª± ƒë·ªông t·∫°o ho·∫∑c l·∫•y t·ª´ tham s·ªë ma)</div>

        <div class="key-container" id="keyBox">
            <input type="text" id="keyInput" readonly />
            <div class="button-group">
                <button id="copyButton">üìã Copy Key</button>
                <button id="musicButton">‚ñ∂Ô∏è Play Music</button>
            </div>
        </div>

        <div id="dateDisplay" style="margin-top:10px; font-size:18px; color:#555;"></div>
        <div class="footer">
            <b>Copyright By
                <a href="https://zalo.me/0822771058" style="color:#ef8682; text-decoration:none;">Nguy·ªÖn Duy Kh√°nh</a>
                | Time: <span id="clock"></span>
            </b>
        </div>
    </div>

    <!-- Blocked overlay (hidden by default) -->
    <div class="blocked-overlay" id="blockedOverlay" style="display:none;">
        <div class="blocked-panel">
            <h2>‚ö†Ô∏è Web kh√¥ng t·ªìn t·∫°i / Ho·∫°t die web</h2>
            <p>Trang n√†y ch·ªâ hi·ªÉn th·ªã key khi b·∫°n m·ªü t·ª´ link g·ªëc (v√≠ d·ª•: link4m) ho·∫∑c khi URL c√≥ tham s·ªë <code>?ma=...</code> / <code>?getkey=1</code>.</p>
            <p>N·∫øu b·∫°n ƒë√£ m·ªü link r√∫t g·ªçn, h√£y th·ª≠ nh·∫•n "Ki·ªÉm tra l·∫°i".</p>
            <div style="margin-top:12px;">
                <button id="retryBtn" style="min-width:120px; margin-right:8px;">üîÅ Ki·ªÉm tra l·∫°i</button>
                <button id="openGuideBtn" style="min-width:120px;">üîó M·ªü link h∆∞·ªõng d·∫´n</button>
            </div>
        </div>
    </div>

<script>
/* ---------- Key generation + localStorage mark (gi·ªØ nguy√™n logic) ---------- */
function generateRandomKey(){
    const prefix = "PHONG-TUS-";
    const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
    let p = "";
    for(let i=0;i<16;i++) p += chars.charAt(Math.floor(Math.random()*chars.length));
    return prefix + p;
}
function markKeyAsUsed(key){
    let used = JSON.parse(localStorage.getItem('usedKeys')||'[]');
    if(!used.includes(key)){ used.push(key); localStorage.setItem('usedKeys', JSON.stringify(used)); }
}
function isKeyUsed(key){
    let used = JSON.parse(localStorage.getItem('usedKeys')||'[]'); return used.includes(key);
}
function generateUniqueKey(){
    let attempts=0, maxAttempts=100, k;
    do{ k = generateRandomKey(); attempts++; if(attempts>maxAttempts){ localStorage.setItem('usedKeys','[]'); break; } } while(isKeyUsed(k));
    return k;
}

/* ---------- Time display ---------- */
function updateTime(){
    const now = new Date();
    const hh = String(now.getHours()).padStart(2,'0');
    const mm = String(now.getMinutes()).padStart(2,'0');
    const ss = String(now.getSeconds()).padStart(2,'0');
    const d = now.getDate(), m = now.getMonth()+1, y = now.getFullYear();
    document.getElementById('clock').textContent = `${hh}:${mm}:${ss}`;
    document.getElementById('dateDisplay').textContent = `H√¥m nay l√† ng√†y ${d}/${m}/${y}`;
    document.title = `Key Ng√†y ${d}/${m}/${y} L√†`;
    setTimeout(updateTime, 1000);
}

/* ---------- Access control: block if not from allowed source ---------- */
function checkAllowedAccess(){
    const params = new URLSearchParams(window.location.search);
    const ma = params.get('ma');
    const getkey = params.get('getkey');
    const ref = document.referrer || '';

    // C√°c hostname ngu·ªìn cho ph√©p (c√≥ th·ªÉ m·ªü r·ªông)
    const allowedHosts = ['link4m.co', 'link4m.vn', 'link4m.com', 'l.link4m.co', 'link4m'];

    // Ki·ªÉm tra n·∫øu referrer ch·ª©a host cho ph√©p
    const hasAllowedRef = allowedHosts.some(h => ref.includes(h));

    // ƒêi·ªÅu ki·ªán cho ph√©p: c√≥ ?ma=... OR ?getkey=1 OR referrer l√† link4m
    if (ma || getkey === '1' || hasAllowedRef) {
        return true;
    }
    return false;
}

function showBlockedOverlay(){
    document.getElementById('blockedOverlay').style.display = 'flex';
    // ·∫®n ph·∫ßn key
    document.getElementById('mainContainer').style.filter = 'blur(2px)';
    // disable buttons
    document.getElementById('copyButton').disabled = true;
    document.getElementById('musicButton').disabled = true;
}

function hideBlockedOverlay(){
    document.getElementById('blockedOverlay').style.display = 'none';
    document.getElementById('mainContainer').style.filter = 'none';
    document.getElementById('copyButton').disabled = false;
    document.getElementById('musicButton').disabled = false;
}

/* ---------- Handle URL params to fill key ---------- */
function handleQueryParams(){
    const params = new URLSearchParams(window.location.search);
    const ma = params.get('ma');
    const getkey = params.get('getkey');
    const keyInput = document.getElementById('keyInput');

    if(getkey === '1'){
        const newKey = generateUniqueKey();
        keyInput.value = newKey;
        markKeyAsUsed(newKey); // n·∫øu b·∫°n mu·ªën ƒë√°nh d·∫•u ngay khi t·∫°o
        console.log('ƒê√£ t·∫°o key m·ªõi:', newKey);
    } else if(ma){
        keyInput.value = ma;
    } else {
        keyInput.value = generateRandomKey(); // m·∫´u
    }
}

/* ---------- Copy + play music on copy ---------- */
const copyBtn = document.getElementById('copyButton');
copyBtn.addEventListener('click', copyToClipboard);

async function copyToClipboard(){
    const keyInput = document.getElementById('keyInput');
    const key = keyInput.value || '';
    if(!key) return;

    // modern clipboard API
    try {
        await navigator.clipboard.writeText(key);
    } catch (e) {
        // fallback
        keyInput.select();
        document.execCommand('copy');
    }

    // feedback button text
    const originalText = copyBtn.textContent;
    copyBtn.textContent = '‚úÖ ƒê√£ copy!';
    setTimeout(()=> copyBtn.textContent = originalText, 2000);

    // mark as used (optional - depending on logic)
    markKeyAsUsed(key);

    // start youtube music (if ready)
    if (typeof ytPlayer !== 'undefined' && ytPlayerReady) {
        // restart track from start
        try {
            ytPlayer.seekTo(0);
            ytPlayer.playVideo();
            musicButtonUpdateState(true);
        } catch(err) {
            console.warn('Kh√¥ng th·ªÉ play youtube player:', err);
        }
    } else {
        // if youtube API ch∆∞a s·∫µn s√†ng, c·ªë g·∫Øng t·∫°o player ngay b√¢y gi·ªù (s·∫Ω play khi onReady g·ªçi)
        if (!ytPlayerInitializing) {
            initYouTubePlayer(); // kh·ªüi t·∫°o l·∫ßn cu·ªëi n·∫øu ch∆∞a
        }
        // l∆∞u c·ªù y√™u c·∫ßu ph√°t khi ready
        playWhenReady = true;
    }
}

/* ---------- YouTube Player API integration ---------- */
/* S·ª≠ d·ª•ng video ID t·ª´ YouTube link b·∫°n g·ª≠i: UKox4YEvLpg */
let ytPlayer;
let ytPlayerReady = false;
let ytPlayerInitializing = false;
let playWhenReady = false;
const YT_VIDEO_ID = 'UKox4YEvLpg'; // ƒë·ªïi n·∫øu c·∫ßn
// t·∫£i API
function initYouTubePlayer(){
    if (ytPlayerInitializing || typeof YT !== 'undefined' && ytPlayer) return;
    ytPlayerInitializing = true;
    // inject YT iframe api script if not present
    if (!document.getElementById('yt-iframe-api')) {
        const tag = document.createElement('script');
        tag.id = 'yt-iframe-api';
        tag.src = "https://www.youtube.com/iframe_api";
        document.head.appendChild(tag);
    }
    // onYouTubeIframeAPIReady s·∫Ω ƒë∆∞·ª£c g·ªçi b·ªüi API khi script load
}

// API callback (YouTube y√™u c·∫ßu h√†m to√†n c·ª•c)
function onYouTubeIframeAPIReady(){
    ytPlayer = new YT.Player('player', {
        height: '0',
        width: '0',
        videoId: YT_VIDEO_ID,
        playerVars: {
            autoplay: 0,
            controls: 0,
            rel: 0,
            modestbranding: 1,
            playsinline: 1
        },
        events: {
            'onReady': function(e){
                ytPlayerReady = true;
                ytPlayerInitializing = false;
                // ƒë·∫∑t volume m·∫∑c ƒë·ªãnh (0-100)
                try { ytPlayer.setVolume(60); } catch(e){}
                if (playWhenReady) {
                    ytPlayer.seekTo(0);
                    ytPlayer.playVideo();
                    playWhenReady = false;
                    musicButtonUpdateState(true);
                }
            },
            'onStateChange': function(event){
                // state change handler n·∫øu c·∫ßn
                // 0 = ended
                if (event.data === 0) {
                    // khi b√†i k·∫øt th√∫c, c·∫≠p nh·∫≠t n√∫t
                    musicButtonUpdateState(false);
                }
            }
        }
    });
}

/* ---------- Music toggle button ---------- */
const musicBtn = document.getElementById('musicButton');
musicBtn.addEventListener('click', toggleMusic);

function toggleMusic(){
    if (typeof ytPlayer !== 'undefined' && ytPlayerReady) {
        const state = ytPlayer.getPlayerState();
        // player states: -1 unstarted, 0 ended, 1 playing, 2 paused
        if (state === 1) {
            ytPlayer.pauseVideo(); musicButtonUpdateState(false);
        } else {
            ytPlayer.playVideo(); musicButtonUpdateState(true);
        }
    } else {
        // if not ready, initialize (will play automatically if user just clicked)
        initYouTubePlayer();
        // request to play when ready
        playWhenReady = true;
        // change button to show pending play
        musicButtonUpdateState(true, '...Loading');
    }
}

function musicButtonUpdateState(isPlaying, overrideText){
    if (overrideText) {
        musicBtn.textContent = '‚è≥ ' + overrideText;
        return;
    }
    musicBtn.textContent = isPlaying ? '‚è∏Ô∏è Pause Music' : '‚ñ∂Ô∏è Play Music';
}

/* ---------- Init ---------- */
window.addEventListener('load', function(){
    updateTime();

    // Ki·ªÉm tra truy c·∫≠p tr∆∞·ªõc khi hi·ªÉn th·ªã key
    if (!checkAllowedAccess()) {
        // ch·∫∑n hi·ªÉn th·ªã key v√† show overlay
        showBlockedOverlay();
    } else {
        // b√¨nh th∆∞·ªùng: x·ª≠ l√Ω tham s·ªë v√† kh·ªüi t·∫°o player
        handleQueryParams();
        initYouTubePlayer(); // kh·ªüi ƒë·ªông s·ªõm (kh√¥ng autoplay) ƒë·ªÉ s·∫µn s√†ng khi ng∆∞·ªùi d√πng copy
    }

    // n√∫t retry cho overlay
    document.getElementById('retryBtn').addEventListener('click', function(){
        // th·ª≠ l·∫°i: n·∫øu referrer l√† link4m ho·∫∑c th√™m ?ma=... th√¨ overlay s·∫Ω ·∫©n
        if (checkAllowedAccess()) {
            hideBlockedOverlay();
            handleQueryParams();
            initYouTubePlayer();
        } else {
            // reload ƒë·ªÉ ch·∫Øc ch·∫Øn referrer ƒë∆∞·ª£c c·∫≠p nh·∫≠t (m·ªôt s·ªë tr√¨nh duy·ªát kh√¥ng set referrer khi ƒë·ªïi c√°ch m·ªü)
            location.reload();
        }
    });

    // n√∫t m·ªü link h∆∞·ªõng d·∫´n (b·∫°n c√≥ th·ªÉ ƒë·ªïi URL ch·ªâ d·∫´n v√†o ƒë√¢y)
    document.getElementById('openGuideBtn').addEventListener('click', function(){
        // m·∫∑c ƒë·ªãnh m·ªü trang g·ªëc hi·ªÉn th·ªã key (b·∫°n ƒë·ªïi KEY_WEB n·∫øu mu·ªën)
        const guide = "https://caoquy2k3.github.io/Phong-tus/"; 
        window.open(guide, '_blank');
    });
});
</script>
</body>
</html>
